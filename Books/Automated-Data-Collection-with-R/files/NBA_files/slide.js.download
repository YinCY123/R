define(['require','exports','module','js/lib/jquery','js/util/clz','js/util/getNodes','js/util/renderLazyContent'],function(require,exports,module){var $=require("js/lib/jquery"),Clz=require("js/util/clz"),getNodes=require("js/util/getNodes"),renderLazyContent=require("js/util/renderLazyContent"),toArray=function(h){var a=[],c=[].slice;try{a=c.call(h)}catch(e){for(var i=0,v=h.length;v>i;i++){var g=h[i];a.push(g)}}return a},Slide=new Clz;return Slide.include({init:function(h,a){var c=this;c.opt=c.setOpt(a),c.clzPrefix=c.opt.prefix,c.dom=getNodes(h,c.opt.attr),c.bind()},setOpt:function(h){var a=h.width||"940",c={prefix:"sina-slide",attr:"node-type",pageWidth:a,width:a,direction:"h",renderLazy:!0,button:{eventType:"mousedown"},pager:{clz:"cur",eventType:"mouseover",showNum:!1},play:{interval:5e3,auto:!0,circularly:!0},effect:{slide:{speed:13,space:10}},callback:{loaded:function(){},slideStart:function(){},slideEnd:function(){},pageChange:function(){}}};return this.dotObjArr=[],this.upright="v"===h.direction,this.pageIndex=0,this._endScroll=0,this._autoTimeObj,this._scrollTimeObj,this._state="ready",this.stripDiv=document.createElement("DIV"),this.lDiv01=document.createElement("DIV"),this.lDiv02=document.createElement("DIV"),$.extend(!0,{},c,h)},pageLength:0,touch:!0,bind:function(){var h=this,a=h.opt;if(!this.dom.cont)throw new Error("必须指定scrollContId.");if(this.scDiv=this.dom.cont[0],!this.scDiv)throw new Error('scrollContId不是正确的对象.(scrollContId = "'+this.dom.cont+'")');this.scDiv.style[this.upright?"height":"width"]=this.opt.width+"px",this.scDiv.style.overflow="hidden",this.lDiv01.innerHTML=this.scDiv.innerHTML,this.scDiv.innerHTML="",this.scDiv.appendChild(this.stripDiv),this.stripDiv.appendChild(this.lDiv01),this.opt.play.circularly&&(this.stripDiv.appendChild(this.lDiv02),this.lDiv02.innerHTML=this.lDiv01.innerHTML),this.slideItems=function(){{var a=[],c=h.lDiv01.children,v=h.lDiv02.children;[].slice}return c=toArray(c),v=toArray(v),a=a.concat(c),a=a.concat(v)}(),this.stripDiv.style.overflow="hidden",this.stripDiv.style.zoom="1",this.stripDiv.style[this.upright?"height":"width"]="32766px",this.lDiv01.style.overflow="hidden",this.lDiv01.style.zoom="1",this.lDiv02.style.overflow="hidden",this.lDiv02.style.zoom="1",this.upright||(this.lDiv01.style.cssFloat="left",this.lDiv01.style.styleFloat="left"),this.lDiv01.style.zoom="1",this.opt.play.circularly&&!this.upright&&(this.lDiv02.style.cssFloat="left",this.lDiv02.style.styleFloat="left"),this.lDiv02.style.zoom="1",this.addEvent(this.scDiv,"mouseover",function(){h.stop()}),this.addEvent(this.scDiv,"mouseout",function(){h.play()}),this.dom.prev&&(this.alObj=this.dom.prev[0],this.alObj&&("click"===a.button.eventType?this.addEvent(this.alObj,"click",function(){h.rightMouseDown(),h.rightEnd()}):(this.addEvent(this.alObj,"mousedown",function(e){h.rightMouseDown(),e=e||event,h.preventDefault(e)}),this.addEvent(this.alObj,"mouseup",function(){h.rightEnd()}),this.addEvent(this.alObj,"mouseout",function(){h.rightEnd()})))),this.dom.next&&(this.arObj=this.dom.next[0],this.arObj&&("click"===a.button.eventType?this.addEvent(this.arObj,"click",function(){h.leftMouseDown(),h.leftEnd()}):(this.addEvent(this.arObj,"mousedown",function(e){h.leftMouseDown(),e=e||event,h.preventDefault(e)}),this.addEvent(this.arObj,"mouseup",function(){h.leftEnd()}),this.addEvent(this.arObj,"mouseout",function(){h.leftEnd()}))));var i,c,v=Math.ceil(this.lDiv01[this.upright?"offsetHeight":"offsetWidth"]/this.opt.width);if(this.pageLength=v,this.data("total",v),this.dom.pager&&(this.dotListObj=this.dom.pager[0],this.dotListObj.innerHTML="",this.dotListObj))for(i=0;v>i;i++)c=document.createElement("a"),this.dotListObj.appendChild(c),this.dotObjArr.push(c),i==this.pageIndex?(c.className=this.opt.pager.clz,this.trigger("complete",this.pageIndex)):c.className="",this.opt.pager.showNum&&(c.innerHTML=i+1),c.title=i+1,c.num=i,c["on"+this.opt.pager.eventType]=function(){h.pageTo(this.num)};this.scDiv[this.upright?"scrollTop":"scrollLeft"]=0,this.opt.play.auto&&this.play(),this._scroll=this.upright?"scrollTop":"scrollLeft",this._sWidth=this.upright?"scrollHeight":"scrollWidth",h.opt.callback.pageChange(this.pageIndex),this.iPad(),this._renderLazy(0),a.callback.loaded()},setScroll:function(h){this.scDiv[this._scroll]=h},leftMouseDown:function(){if("ready"==this._state){var h=this;this._state="floating",clearInterval(this._scrollTimeObj),this.moveLeft(),this._scrollTimeObj=setInterval(function(){h.moveLeft()},this.opt.effect.slide.speed)}},rightMouseDown:function(){if("ready"==this._state){var h=this;this._state="floating",clearInterval(this._scrollTimeObj),this.moveRight(),this._scrollTimeObj=setInterval(function(){h.moveRight()},this.opt.effect.slide.speed)}},moveLeft:function(){var h=this,a=this.opt.effect.slide.space,c=Math.round(this.lDiv01[this._sWidth]),v=this.scDiv[this._scroll];this.opt.play.circularly?h.setScroll(v+a>=c?v+a-c:v+a):v+a>=c-this.opt.width?(h.setScroll(c-this.opt.width),this.leftEnd()):h.setScroll(v+a),this.accountPageIndex()},moveRight:function(){var h=this,a=this.opt.effect.slide.space,c=Math.round(this.lDiv01[this._sWidth]),v=this.scDiv[this._scroll];this.opt.play.circularly?h.setScroll(0>=v-a?c+v-a:v-a):0>=v-a?(h.setScroll(0),this.rightEnd()):h.setScroll(v-a),this.accountPageIndex()},leftEnd:function(){if("floating"==this._state||"touch"==this._state){this._state="stoping",clearInterval(this._scrollTimeObj);var h=this.scDiv[this._scroll],a=this.opt.pageWidth-(h-this._endScroll)%this.opt.pageWidth;this.slide(a,!1,h)}},rightEnd:function(){if("floating"==this._state||"touch"==this._state){this._state="stoping",clearInterval(this._scrollTimeObj);var h=this.lDiv01[this._sWidth],a=this.scDiv[this._scroll],c=0;c=0===this._endScroll?(h-a-this.opt.pageWidth)%this.opt.pageWidth:(this._endScroll-a-this.opt.pageWidth)%this.opt.pageWidth,this.slide(c,!1,a)}},_renderLazy:function(h){var a=this;if(a.opt.renderLazy)for(var i=0,c=a.slideItems.length;c>i;i++){var v=a.slideItems[i];!v._renderLazyFinished&&v.offsetLeft>=a.scDiv[a._scroll]+h&&v.offsetLeft<a.scDiv[a._scroll]+h+a.opt.width&&(v._renderLazyFinished=!0,renderLazyContent(v))}},_onSlideStart:function(h){this._renderLazy(h),this.opt.callback.slideStart()},_onSlideEnd:function(){this._endScroll=this.scDiv[this._scroll],this.opt.callback.slideEnd()},slide:function(h,a,c){var v=this;v._onSlideStart(h),v.move(h,a,c)},move:function(h,a,c){var v=this,g=h/5,D=!1;a||(g>this.opt.effect.slide.space&&(g=this.opt.effect.slide.space),g<-this.opt.effect.slide.space&&(g=-this.opt.effect.slide.space)),g=Math.abs(g)<1&&0!=g?g>=0?1:-1:Math.round(g);var _=this.lDiv01[this._sWidth];c=c||this.scDiv[this._scroll];var y=0;return g>0?this.opt.play.circularly?y=c+g>=_?c+g-_:g+c:c+g>=_-this.opt.width?(y=_-this.opt.width,this._state="ready",D=!0):y=g+c:this.opt.play.circularly?y=0>c+g?_+c+g:g+c:0>c-g?(y=0,this._state="ready",D=!0):y=g+c,v.setScroll(y),D?void 0:(h-=g,Math.abs(h)<1&&0!==h&&(h=0,v.move(h,a)),0==Math.abs(h)?(v._onSlideEnd(),this._state="ready",this.opt.play.auto&&this.play(),void this.accountPageIndex()):(this.accountPageIndex(),void(this._scrollTimeObj=setTimeout(function(){v.move(h,a,y)},this.opt.effect.slide.speed))))},pre:function(){"ready"==this._state&&(this._state="stoping",this.pageTo(this.pageIndex-1))},next:function(h){"ready"==this._state&&(this._state="stoping",this.opt.play.circularly?this.pageTo(this.pageIndex+1):this.scDiv[this._scroll]>=this.lDiv01[this._sWidth]-this.opt.width?(this._state="ready",h&&this.pageTo(0)):this.pageTo(this.pageIndex+1))},play:function(){var h=this;this.opt.play.auto&&(clearInterval(this._autoTimeObj),this._autoTimeObj=setInterval(function(){h.leftMouseDown(),h.leftEnd()},this.opt.play.interval))},stop:function(){clearInterval(this._autoTimeObj)},pageTo:function(h){if(this.pageIndex!=h){0>h&&(h=this.pageLength-1),clearTimeout(this._scrollTimeObj),this._state="stoping";var a=this.scDiv[this._scroll],c=h*this.opt.width-a;this.slide(c,!0,a)}},accountPageIndex:function(){var h=this,a=Math.round(this.scDiv[this._scroll]/this.opt.width);if(a>=this.pageLength&&(a=0),a!=this.pageIndex){this.pageIndex=a,this.pageIndex>Math.floor(this.lDiv01[this.upright?"offsetHeight":"offsetWidth"]/this.opt.width)&&(this.pageIndex=0);var i;for(i=0;i<this.dotObjArr.length;i++)i==this.pageIndex?(this.dotObjArr[i].className=this.opt.pager.clz,this.trigger("complete",a)):this.dotObjArr[i].className="";h.opt.callback.pageChange(this.pageIndex)}},iPadX:0,iPadLastX:0,iPadStatus:"ok",iPad:function(){if("undefined"!=typeof window.ontouchstart&&this.touch){var h=this;this.addEvent(this.scDiv,"touchstart",function(e){h._touchstart(e)}),this.addEvent(this.scDiv,"touchmove",function(e){h._touchmove(e)}),this.addEvent(this.scDiv,"touchend",function(e){h._touchend(e)})}},_touchstart:function(e){this.stop(),this.iPadX=e.touches[0].pageX,this.iPadScrollX=window.pageXOffset,this.iPadScrollY=window.pageYOffset,this.scDivScrollLeft=this.scDiv[this._scroll]},_touchmove:function(e){e.touches.length>1&&this._touchend(),this.iPadLastX=e.touches[0].pageX;var h=this.iPadX-this.iPadLastX;if("ok"==this.iPadStatus){if(!(this.iPadScrollY==window.pageYOffset&&this.iPadScrollX==window.pageXOffset&&Math.abs(h)>20))return;this.iPadStatus="touch"}this._state="touch";var a=this.scDivScrollLeft+h;a>=this.lDiv01[this._sWidth]&&(a-=this.lDiv01[this._sWidth]),0>a&&(a+=this.lDiv01[this._sWidth]),this.scDiv[this._scroll]=a,e.preventDefault()},_touchend:function(){if("touch"==this.iPadStatus){this.iPadStatus="ok";var h=this.iPadX-this.iPadLastX;0>h?this.rightEnd():this.leftEnd(),this.play()}},$:function(objName){return eval(document.getElementById?'document.getElementById("'+objName+'")':"document.all."+objName)},isIE:-1!=navigator.appVersion.indexOf("MSIE")?!0:!1,addEvent:function(h,a,c){h.attachEvent?h.attachEvent("on"+a,c):h.addEventListener(a,c,!1)},delEvent:function(h,a,c){h.detachEvent?h.detachEvent("on"+a,c):h.removeEventListener(a,c,!1)},preventDefault:function(e){e.preventDefault?e.preventDefault():e.returnValue=!1}}),Slide});