define(function (require, exports, module) {
    var $ = require('js/lib/jquery');
    var ScrollPic = require('js/util/scrollPic');

    function Schedule(id, opt) {
        var self = this;
        self.id = id;
        self.wrap = $("#" + id);
        self.opt = self.setOpt(opt);
        self.slider = null;
        self.init();
    };
    Schedule.prototype = {
        setOpt: function (opt) {
            var self = this;
            var defaults = {
                arrLeftId: '',
                arrRightId: '',
                frameWidth: 950,
                pageWidth: 760,
                url: '',
                jsonpCallback: '',
                interval: null,
                delay: 60 * 1000,//一分钟
                staMap: {
                    0: '未开始',
                    1: '直播中',
                    2: '已结束',
                },
                //处理数据
                processData: function (d) { },
                tpl: '<div class="schedule__item  fl %icons%" uniq="%uniq%" sta="%sta%"  winner="%winner%"><a class="schedule__item_cont" href="%url%" target="_blank"><div class="schedule__item_hd clearfix"><i class="fr icon_status"></i><p><span class="hd_match" title="%title%">%title%</span><span class="hd_rnd" title="%rnd%">%rnd%</span></p></div><div class="schedule__item_bd"><p class="clearfix" hv="1"><i class="winner fr"></i>%fr1%<span title="%tname1%">%tname1%</span></p><p class="clearfix" hv="2"><i class="winner fr"></i>%fr2%<span title="%tname2%">%tname2%</span></p></div></a><div class="schedule__item_ft"><ul class="clearfix">%list%</ul></div></div>',
            };
            return $.extend(true, {}, defaults, opt);
        },

        //card跳转URL
        processUrl: function (d) {
            var sta = d.status;
            if (sta == "0" || sta == "1") {
                return d.live_room || d.textlive_url || d.topic_url;
            }
            else {
                return d.gossip || d.textlive_url || d.topic_url;
            }
        },

        //获取数据
        getData: function (opt) {
            var self = this;
            $.ajax({
                url: opt.url,
                dataType: opt.dataType,
                data: { leagueid: opt.leagueid, app_key: opt.app_key, dpc: 1 },
                cache: true,
                jsonpCallback: 'cb_' + '246c7fc4-4cdb-4261-807f-7396b17d1ed5'.replace(/-/g, '_'),
                success: function (d) {
                    var data = self.opt.processData(d);
                    self.paintData(data);
                }
            })
        },
        //获取底部list
        getList: function (d) {
            //var self=this;
            //var match=self.opt.match;
            var sta = d.status;
            var hasyouhupc = d.youkupc ? true : false;
            var preUrls = [{ "name": "视频", "url": d.live_room }, { "name": "图文", "url": d.textlive_url }, { "name": "专题", "url": d.topic_url || '' }, { "name": "统计", "url": d.tongji_url }, { "name": "视频", "url": d.youkupc, "youkupc":  hasyouhupc}, { "name": "预测", "url": d.lottery_url || '' }];
            var durUrls = [{ "name": "视频", "url": d.live_room }, { "name": "图文", "url": d.textlive_url }, { "name": "高清图", "url": d.pic }, { "name": "统计", "url": d.tongji_url }, { "name": "视频", "url": d.youkupc, "youkupc": hasyouhupc }, { "name": "预测", "url": d.lottery_url || '' }, { "name": "专题", "url": d.topic_url || '' }];
            var aftUrls = [{ "name": "集锦", "url": d.gossip }, { "name": "视频", "url": d.live_room }, { "name": "战报", "url": d.battle }, { "name": "高清图", "url": d.pic }, { "name": "统计", "url": d.tongji_url }, { "name": "视频", "url": d.youkupc, "youkupc": hasyouhupc }, { "name": "图文", "url": d.textlive_url }, { "name": "专题", "url": d.topic_url || '' }];
            getStatusList = function (l) {
                var _list = [];
                for (i = 0, len = l.length; i < len; i++) {
                    if (l[i].url && _list.length < 3) {
                        _list.push('<li><a href="' + l[i].url + '" target="_blank">' + l[i].name + '</a></li>');
                    } else if (l[i].url && l[i].youkupc) {
                        _list.push('<li><a href="' + l[i].url + '" target="_blank">' + l[i].name + '</a></li>');
                    }
                }
                return _list.join('');
            };
            if (sta == "0") { return getStatusList(preUrls) };
            if (sta == "1") { return getStatusList(durUrls) };
            if (sta == "2") { return getStatusList(aftUrls) };
        },
        //获取比赛日期
        getPeriod: function (d, sta, date, time) {
            var self = this;
            if (!date || !time) return;
            date = new Date(date.replace(/-/g, '/'));
            var month = date.getMonth() + 1;//获取月份
            var day = date.getDate();
            var obj = {
                day: month + '/' + day,
                time: time
            }
            if (sta === 0) return obj;
            return self.opt.staMap[sta] || '';
        },
        //跳转到正在直播的第一页
        jumpTo: function (w) {
            var self = this;
            id = self.id
            slider = new ScrollPic();
            slider.scrollContId = id;
            slider.arrLeftId = self.opt.arrLeftId;
            slider.arrRightId = self.opt.arrRightId;
            slider.arrEndHidden = true;
            slider.autoPlay = false;
            slider.circularly = false;
            slider.frameWidth = self.opt.frameWidth;
            slider.pageWidth = self.opt.pageWidth;
            slider.initialize();
            scroll[id] = true;
            var $match_item = w.find(".schedule__item"),
                match_duing = w.find(".schedule__item[sta='1']")//比赛中
            match_prev = w.find(".schedule__item[sta='0']");//未开始

            var idx = 0;
            if (match_duing && match_duing.length !== 0) {
                idx = $match_item.index($(match_duing));
            } else if (match_prev) {
                idx = $match_item.index($(match_prev));
            } else {
                idx = 1;
            }
            var page = Math.floor(idx / 4);
            // 滚动到正在直播第一页
            slider.pageTo(page);
        },
        //渲染信息
        paintData: function (s) {
            var self = this;
            var h = [], d, i, l, sta, team1_score, team2_score;
            for (i = 0, l = s.length; i < l; i++) {
                var result_tpl = null;
                d = s[i];
                sta = d.status - 0;
                team1_score = d.team1_score - 0;
                team2_score = d.team2_score - 0;
                var process_url = self.processUrl(d);
                var list = self.getList(d);
                var result_tpl =
                    self.opt.tpl.replace(/%icons%/, d.live_room || d.gossip ? sta === 1 ? 'iconbs icon_video_live' : 'iconbs icon_video_record' : '')
                        .replace(/%sta%/, sta)
                        .replace(/%uniq%/, d[self.opt.uniq])
                        .replace(/%winner%/, sta < 2 ? '' : (team1_score > team2_score) ? '1' : (team1_score < team2_score) ? '2' : '')
                        .replace(/%url%/, process_url)
                        .replace(/%title%/g, d.ShortTitle ? d.ShortTitle : self.opt.title)
                        .replace(/%rnd%/g, sta === 1 ? self.getPeriod(d, sta, d.date, d.time) : (d.round === d.host ? '' : d.round))
                        .replace(/%tname1%/g, d.host ? d.host : d.Title)
                        .replace(/%tname2%/g, d.visit)
                        .replace(/%fr1%/, sta > 0 ? '<span class="fr bd_score">' + (d.team1_score || "") + '</span>' : '<span class="bd_date fr">' + self.getPeriod(d, sta, d.date, d.time).day + '</span>')
                        .replace(/%fr2%/, sta > 0 ? '<span class="fr bd_score">' + (d.team2_score || "") + '</span>' : '<span class="bd_time fr">' + self.getPeriod(d, sta, d.date, d.time).time + '</span>')
                        .replace(/%list%/, list)

                h.push(result_tpl);
            }
            h.push('<div class="schedule__item fl schedule__more"><div class="schedule__item_hover"></div><a class="schedule__item_cont" href="http://match.sports.sina.com.cn/index.html" target="_blank">查看更多比赛</a></div>');
            var w = self.wrap, id = self.id;
            w.hide();
            if (scroll[id]) {
                self.refreshData(s);
                return w.show();
            }
            w.html(h.join('')).show();
            self.jumpTo(w);
        },
        //刷新
        refreshData: function (s) {
            var self = this;
            var i, l, d, sta, ww, t, team1_score, team2_score;
            for (i = 0, l = s.length; i < l; i++) {
                d = s[i];
                sta = d.status - 0;
                team1_score = d.team1_score - 0;
                team2_score = d.team2_score - 0;
                ww = self.wrap.find('.schedule__item[uniq="' + d[self.opt.uniq] + '"]');
                ww.attr('sta', sta).attr('winner', sta < 2 ? '' : (team1_score > team2_score) ? '1' : (team1_score < team2_score) ? '2' : '').removeClass('iconbs icon_video_record icon_video_live').addClass(d.live_room || d.gossip ? sta === 1 ? 'iconbs icon_video_live' : 'iconbs icon_video_record' : '');
                ww.find('p[hv="1"] span.fr').html(sta > 0 ? (d.team1_score || "") : self.getPeriod(d, sta, d.date, d.time).day).removeClass('bd_date').removeClass('bd_score').addClass(sta > 0 ? 'bd_score' : 'bd_date');
                ww.find('p[hv="2"] span.fr').html(sta > 0 ? (d.team2_score || "") : self.getPeriod(d, sta, d.date, d.time).time).removeClass('bd_time').removeClass('bd_score').addClass(sta > 0 ? 'bd_score' : 'bd_time');
                ww.find('.hd_rnd').attr('title', sta == 1 ? self.getPeriod(d, sta, d.date, d.time) : (d.round === d.host ? '' : d.round)).html(sta == 1 ? self.getPeriod(d, sta, d.date, d.time) : (d.round === d.host ? '' : d.round));
                ww.find('.schedule__item_ft ul').html(self.getList(d));
                if (sta == 1) {
                    var pr = self.getPeriod(d, sta, d.date, d.time);
                    ww.find('.hd_rnd').attr('title', pr).text(pr);
                }
            }
        },
        init: function () {
            var self = this;
            self.getData(self.opt);
            interval = setInterval(function () {
                self.getData(self.opt);
            }, self.opt.delay);
        }
    }
    return Schedule;
})

