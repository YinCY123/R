seajs.use(['jquery', 'AutoPicker', 'LoadFeedIntelligent', 'as/tab', 'as/search', 'as/focus', 'as/select', 'as/selectpop', '//www.autohome.com.cn/grade/javascript/slider.js'], function ($, AutoPicker, Loader) {

    AutoPicker.init();
    Loader.init();


    function loadLottery() {

        var clubusershow = getCookie('clubUserShow');
        if (clubusershow == undefined || clubusershow == '') {
            showLottery();
        }

        $.ajax({
            type: 'get',
            url: "/ajax/user/info?headlottery=1",
            dataType: 'json',
            success: function (result) {
                if (result.returncode == 0 && result.result.canHeadLottery) {
                    showLottery();
                }

            }
        });


    }

    function getCookie(name) {

        var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
        if (arr = document.cookie.match(reg))
            return unescape(arr[2]);
        else
            return '';

    }



    $('a[data-toggle="tab"]').tab({
        trigger: 'hover',
        delay: 50
    });


    $('#focus1').focus({
        interval: 5000,
        toggleButton: true
    });

    //车型比对按钮
    $("#koubeicompare").on('click', function () {
        var specid = $("input[name=SpecId]").val();
        var seriesid = $("input[name=SeriesId]").val();

        if (seriesid == '0' && specid == '0') {
            return;
        }
        if (specid != 0) {
            window.open('//k.autohome.com.cn/comparecar/' + specid + '#pvareaid=101385');

        } else {
            if (seriesid != 0) {
                window.open('//k.autohome.com.cn/compareseries/' + seriesid + '#pvareaid=101385');
            }
        }
    });

    //下拉菜单显示隐藏
    $('.selects-btn').live('click', function () {
        var className = $(this).attr('class');
        if (className.indexOf('active') >= 0) {
            $(this).removeClass('active');
        } else {
            $('.selects-btn').removeClass('active');
            $(this).addClass('active');
        }
    })


    $('.step').live('click', function () {
        $(this).addClass('active');
        $(this).siblings().removeClass('active');
    })

    //显示价格区间
    $(".tip-content").bind('DOMNodeInserted', function (e) {
        $('.price-val').text($(this).text());
    });

    //类型下拉菜单显示隐藏
    $('.tag.more').live('click', function () {
        var drop = $('.dropdown');
        var display = drop[0].style.display;
        if (display === 'none') {
            drop.show();
        } else {
            drop.hide();
        }
    })

    //口碑推荐加载更多
    $('#koubeiGetMore').on('click', function (e) {
        var koubeiPageNum = parseInt($("#koubeiPageNum").val());
        koubeiPageNum += 1;
        Loader.getFeedIntelligentList(koubeiPageNum, 10);
        $("#koubeiPageNum").val(koubeiPageNum);
    })


    //口碑推荐加载更多
    $('#sceneGetMore').on('click', function (e) {
        Loader.getSceneSelectCarByCache();
    })


    $("a[name='resultSort']").on('click', function (e) {
        var flag;
        var datatype = $(this).attr("datatype");
        if (datatype == "peopleNumSort") {
            flag = Loader.getSortPeopleNumHtml();
        } else if (datatype == "koubeiScoreSort") {
            flag = Loader.getSortKoubeiScoreHtml();
        }
        if (flag) {
            var className = $(this)[0].className;
            //已选中状态
            if (className.indexOf("select") != -1) {
                return false;
            } else {
                $(this).siblings().removeClass("select")
                $(this).addClass("select");
            }
        }
    })


    $('body').on('click', '.car-item', function (e) {
        var seriesid = $(this).attr("sereisid");
        if (seriesid != undefined) {
            window.open("https://k.autohome.com.cn/" + seriesid + "/#pvareaid=2099124");
        }
    });

    $('.selects-btn').hover(function () {
        $(this).addClass('active');
        // }
    }, function () {
        $(this).removeClass('active');
    })

    //显示车辆类型
    $('.tag').live('click', function () {
        //获取车型样式名称
        var className = $(this)[0].className;

        //如果不是更多下拉菜单
        if (className.indexOf('more') === -1) {
            //将更多下拉菜单隐藏
            $('.dropdown').hide();

            if (className.indexOf('down') === -1) {
                carTag($(this), className)
            } else {
                moreCarTag($(this), className);
            }
        } else {
            return false;
        }
        Loader.levelContext($(this), "level");
    })


    //价格区间显示滑动显示
    $("#price-range").slider({
        unit: "万",
        beyondMax: true,
        beyondMin: true,
        firstWidth: 34,
        lastWidth: 23,
        scale: [{
            key: 2,
            value: [1, 1, 1]
        },
            {
                key: 5,
                value: [1, 1, 1, 1, 1]
            },
            {
                key: 10,
                value: [1, 1, 1, 1, 1]
            },
            {
                key: 15,
                value: [1, 1, 1, 1, 1]
            },
            {
                key: 20,
                value: [1, 1, 1, 1, 1]
            },
            {
                key: 25,
                value: [1, 1, 1, 1, 1]
            },
            {
                key: 30,
                value: [1, 1, 1, 1, 1]
            },
            {
                key: 35,
                value: [3, 2, 5, 3, 2]
            },
            {
                key: 50,
                value: [5, 5, 5, 5]
            },
            {
                key: 70,
                value: [10, 10, 10]
            },
            {
                key: 100,
                value: 0.5
            },
            {
                key: 110
            }]
    }).on("changed", function (e, args) {
        var min = args.value.leftValue,
            max = args.value.rightValue;
        if (min == 2) min = 1;
        if (6680 > 110) {
            if (max == 6680) max = 1;
        } else {
            if (max == 110) max = 1;
        }
        if (max == 10000) max = 1;
        if (min + '_' + max == '2_6680') {
            min = 0;
            max = 0;
        }

        Loader.priceContext(min, max)
    });

    $("#price-range").data("slider").setValue({
        leftValue: 2,
        rightValue: 110,
        triggerEvent: false
    });

    $("#sceneCarCache").data("carCache", {
        minprice: 2,
        maxprice: 110,
        _appid: "koubei"
    });


    //显示国家
    $("input[name='country']").live('click', function () {
        Loader.commonContext($(this), "country", "countryfilter");
    })

    //显示动力
    $("input[name='fueltype']").live('click', function () {
        Loader.commonContext($(this), "fueltype", "powerfilter");
    })

    //显示场景
    $("input[name='sceneTag']").live('click', function () {
        Loader.commonContext($(this), "tag", "sencefilter");
    })


    $('#clearCarPrice').live('click', function () {
        Loader.specialClearContextg($(this), "price");
    })

    $('#clearCarType').live('click', function () {
        Loader.specialClearContextg($(this), "level");
    });

    $("i[id^='countryfilter']").live('click', function () {
        Loader.commonClearContext($(this), "country", "countryfilter");
    });

    $("i[id^='powerfilter']").live('click', function () {
        Loader.commonClearContext($(this), "fueltype", "powerfilter");
    });

    $("i[id^='sencefilter']").live('click', function () {
        Loader.commonClearContext($(this), "tag", "sencefilter");
    });


    $("#clear").live('click', function () {
        Loader.clearAllContext();
    })

    //首页默认展示车型
    function carTag(obj, className) {
        //如果当前车型没有被选项
        if (className.indexOf('selected') === -1) {
            //是首页展示车型，清空其它选项选中状态
            obj.siblings().removeClass('selected');
            //为当前选项添加选中状态
            obj.addClass('selected');
            $("#tagMore").html('更多<i class="icon10 icon10-sjb"></i>');
            $("#dropdownContent li a").removeClass('selected');
        } else {
            //已选中，则删除选状态
            obj.removeClass('selected');
        }
    }


    //更多选项内车型
    function moreCarTag(obj, className) {
        //清空更多菜单选项车型选中状态
        $("#dropdownContent li a").removeClass('selected');
        //清空首页展示车型选中状态
        $("#tagMore").siblings().removeClass('selected');
        obj.addClass('selected');
        $("#tagMore").html(obj.html() + '<i class="icon10 icon10-sjb"></i>');
        $("#tagMore").addClass("selected");
    }

    $(".tag:first").click();


});

