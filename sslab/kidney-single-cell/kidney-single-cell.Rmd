---
author: "yincy"
date: "1/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

```{r, message=FALSE}
library(Seurat)
library(dplyr)
library(tidyr)
library(magrittr)
library(Matrix)
```

# Murine endothelial cell   
## transform to spare matrix  
```{r}
sc <- read.table(file = "f:/altas_endo/E-MTAB-8077.processed.1/raw_count_matrix_kidney.txt", 
                 header = T, 
                 row.names = 1) %>% 
    as.matrix()

sc %>% class()
sc %>% dim()
sc %>% .[1:5, 1:5]


sc.spare <- Matrix(data = sc, sparse = T)
sc.spare %>% .[1:3, 1:3]
```

save the files  
```{r}
writeMM(obj = sc.spare, 
        file = "f:/altas_endo/E-MTAB-8077.processed.1/kidney_spare_matrix/matrix.mtx")

# save row names  
write(x = rownames(sc), 
      file = "f:/altas_endo/E-MTAB-8077.processed.1/kidney_spare_matrix/features.tsv",
      sep = "\t")


# save the colnames  
write(x = colnames(sc), 
      file = "f:/altas_endo/E-MTAB-8077.processed.1/kidney_spare_matrix/barcodes.tsv", 
      sep = "\t", 
      ncolumns = 1)
```


## load the data into Seurat  
```{r}
kidney_sc <- Read10X(data.dir = "f:/altas_endo/E-MTAB-8077.processed.1/kidney_spare_matrix/", 
                     gene.column = 1) %>% 
  CreateSeuratObject(project = "kidney endothelial")
```

```{r}
kidney_sc$percent.mt <- PercentageFeatureSet(object = kidney_sc, pattern = "^mt-")
quantile(kidney_sc$percent.mt, probs = seq(0, 1, 0.05))
```

```{r}
VlnPlot(object = kidney_sc, features = kidney_sc[[]] %>% colnames() %>% .[2:4], ncol = 3)
```

```{r}
plot(kidney_sc[[]][, 2:4])
```


## filtering  
```{r}
kidney_sub <- subset(kidney_sc, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)
```

## Processing  
```{r}
kidney_sub <- kidney_sub %>% 
  NormalizeData(normalization.method = "LogNormalize", scale.factor = 10000) %>% 
  FindVariableFeatures(nfeatures = 1000) %>% 
  ScaleData(features = rownames(kidney_sub)) %>% 
  RunPCA(npcs = 10) %>% 
  FindNeighbors(dims = 1:10) %>% 
  FindClusters(resolution = 0.6) %>% 
  RunTSNE(dims = 1:10) %>% 
  RunUMAP(dims = 1:10)
```


```{r}
UMAPPlot(kidney_sub, label = T)
```

```{r}
FeaturePlot(object = kidney_sub, features = c("Plat", "Lpl", "Pi16"))
```

```{r}
glomeruli_endo <- kidney_sub[, Idents(kidney_sub) == 6]
```







