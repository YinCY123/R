---
title: "C1aqa upstream signal"
author: "yincy"
date: "11/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(org.Mm.eg.db)
library(tidygraph)
library(ggraph)
library(igraph)
library(stringr.plus)
```


# load KEGG pathway  
```{r}
all_path_df <- read.csv(file = "../res/P2ry12/all_pathways_df.csv", 
                        stringsAsFactors = F)

all_path_df %>% dim()
all_path_df %>% pull(type) %>% table()
all_path_df %>% pull(subtype) %>% table()

all_path_df %>% head()
all_path_df <- all_path_df %>% distinct(from, to, .keep_all = T)
all_path_df %>% dim()

all_path_df %>% 
  dplyr::filter(type == "maplink")

all_path_df <- all_path_df %>% 
  dplyr::filter(type != "maplink")
all_path_df %>% dim()

all_path_df$from <- gsub("mmu:", replacement = "", all_path_df$from)
all_path_df$to <- gsub("mmu:", replacement = "", all_path_df$to)

all_path_df %>% dim()
all_path_df %>% head()
```

## add subtype information  
```{r}
# get KEGG compound information
# KEGG_compounds <- keggList("compound")
# KEGG_compounds[10:20]
# saveRDS(object = KEGG_compounds, file = "KEGG_compounds.rds")
KEGG_compounds <- readRDS(file = "KEGG_compounds.rds")
KEGG_compound_ids <- names(KEGG_compounds)

pat_location <- str_locate(string = KEGG_compounds, pattern = ";")
ll <- pat_location[, 1]

KEGG_compounds_value <- as.vector(KEGG_compounds)
KEGG_compounds_value[10:20]

extracted_str <- c()
for(i in seq_along(ll)){
  if(is.na(ll[i])){
    extracted_str <- append(extracted_str, KEGG_compounds_value[i])
  }else{
    extracted_str <- append(extracted_str, substr(KEGG_compounds_value[i], start = 1, stop = ll[i] - 1))
  }
}

KEGG_compounds_to_display <- str_trim(extracted_str, "both")
names(KEGG_compounds_to_display) <- KEGG_compound_ids
KEGG_compounds_to_display[10:20]
```

```{r}
# get KEGG gene information
# KEGG_mmu_genes <- keggList("mmu")
# saveRDS(object = mmu_genes, file = "KEGG_mmu_genes.rds")
KEGG_mmu_genes <- readRDS(file = "KEGG_mmu_genes.rds")
KEGG_mmu_genes %>% head()

library(org.Mm.eg.db)
KEGG_mmu_genes_df <- AnnotationDbi::select(x = org.Mm.eg.db, 
                       keys = KEGG_mmu_genes, 
                       keytype = "ENTREZID", 
                       columns = c("ENTREZID", "SYMBOL"))
KEGG_mmu_genes_df

KEGG_mmu_genes_to_display <- KEGG_mmu_genes_df$SYMBOL
names(KEGG_mmu_genes_to_display) <- KEGG_mmu_genes_df$ENTREZID
KEGG_mmu_genes_to_display %>% head()
```

```{r}
# get KEGG glycan information  
# KEGG_glycan <- keggList("glycan")
# saveRDS(object = KEGG_glycan, file = "KEGG_glycan.rds")
KEGG_glycan <- readRDS(file = "KEGG_glycan.rds")
KEGG_glycan %>% head()

KEGG_glycan_ids <- names(KEGG_glycan)
KEGG_glycan_ids %>% head()

KEGG_glycan_values <- KEGG_glycan %>% as.vector()
KEGG_glycan_values %>% head()

pat_location <- str_locate(KEGG_glycan, ";")
pat_location %>% dim()
ll <- pat_location[, 1]

extracted_str <- c()
for(i in seq_along(ll)){
  if(is.na(ll[i])){
    extracted_str <- append(extracted_str, KEGG_glycan_values[i])
  }else{
    extracted_str <- append(extracted_str, substr(KEGG_glycan_values[i], start = 1, stop = ll[i] - 1))
  }
}

KEGG_glycan_to_dispaly <- str_trim(extracted_str, "both")
names(KEGG_glycan_to_dispaly) <- KEGG_glycan_ids
KEGG_glycan_to_dispaly[1:10]
```

```{r}
# get KEGG drug information 
# KEGG_drug <- keggList("drug")
# saveRDS(object = KEGG_drug, file = "KEGG_drug.rds")
KEGG_drug <- readRDS(file = "KEGG_drug.rds")
KEGG_drug %>% head()

KEGG_drug_ids <- names(KEGG_drug)
KEGG_drug_values <- KEGG_drug %>% as.vector()
KEGG_drug_values %>% head()

pat_location <- str_locate(string = KEGG_drug, pattern = ";")
ll <- pat_location[, 1]

extracted_str <- c()
for(i in seq_along(ll)){
  if(is.na(ll[i])){
    extracted_str <- append(extracted_str, KEGG_drug_values[i])
  }else{
    extracted_str <- append(extracted_str, substr(KEGG_drug_values[i], start = 1, stop = ll[i] - 1))
  }
}

KEGG_drug_to_display <- extracted_str

## remove parenthesis 
KEGG_drug_to_display <- str_replace(KEGG_drug_to_display, "[ ]*\\(?[[:alnum:][:punct:]]*\\)?$", "")
names(KEGG_drug_to_display) <- KEGG_drug_ids
KEGG_drug_to_display %>% head()
```

```{r}
# some rows in from and to contain multiple ids, retain only the first one
ll <- str_locate(all_path_df$from, " ") %>% .[, 1]
all_path_df[!(ll %>% is.na()), ]

for(i in seq_along(ll)){
  if(is.na(ll[i])){
    all_path_df$from[i] <- all_path_df$from[i]
  }else{
    all_path_df$from[i] <- str_extract_before(all_path_df$from[i], " ")
  }
}


ll <- str_locate(all_path_df$to, " ") %>% .[, 1]
all_path_df[!(ll %>% is.na()), ]

for(i in seq_along(ll)){
  if(is.na(ll[i])){
    all_path_df$to[i] <- all_path_df$to[i]
  }else{
    all_path_df$to[i] <- str_extract_before(all_path_df$to[i], " ")
  }
}

all_path_df$from <- str_trim(string = all_path_df$from, side = "both")
all_path_df$to <- str_trim(string = all_path_df$to, side = "both")

names_to_display <- c(KEGG_mmu_genes_to_display, 
                      KEGG_compounds_to_display, 
                      KEGG_drug_to_display, 
                      KEGG_glycan_to_dispaly)
```


```{r}
subtype_element <- data.frame(
  name = c("compound", "hidden compound", "activation", "inhibition", 
           "expression", "repression", "indirect effect", "state change", 
           "binding/association", "dissociation", "missing interaction", 
           "phosphorylation", "dephosphorylation", "glycosylation", "ubiquitination", 
           "methylation"), 
  value = c(NA, 
            NA, 
            "-->", "--|", "-->", "--|", "..>", 
            "...", "---", "-+-", "-/-",
            "+p", "-p", "+g", "+u", "+m"), 
  stringsAsFactors = F
)

subtype_element

vl <- subtype_element$value
names(vl) <- subtype_element$name

all_path_df$subtype %>% unique()
intersect(all_path_df$subtype %>% unique(), subtype_element$name)

all_path_df$subtype_value <- vl[all_path_df$subtype]
all_path_df %>% dplyr::filter(subtype != "compound")

## add edge and node info
all_path_df$angle <- ifelse(all_path_df$subtype == "inhibition", 90, 30)
all_path_df$edge_label <- ifelse(grepl("[a-z]", all_path_df$subtype_value), all_path_df$subtype_value, NA)

lty <- c(rep(1, 5), 5, 1, 3, 1, 5, 3, 5, 1, 3, 1)
names(lty) <- all_path_df$subtype %>% unique() %>%  as.character()
all_path_df$lty <- lty[all_path_df$subtype]
all_path_df$lty <- ifelse(is.na(all_path_df$lty), 1, all_path_df$lty)
all_path_df$edge_label <- ifelse(is.na(all_path_df$edge_label), "", all_path_df$edge_label)

all_path_df %>% dplyr::filter(is.na(lty))
```


```{r}
ig <- graph_from_data_frame(d = all_path_df[, c("from", "to")], directed = T)
distance_to_C1qa_all_path <- shortest_paths(ig, from = V(ig)$name == "12259", to = V(ig), mode = "all")[[1]]

list2df <- function(list){
  maxL <- sapply(list, length) %>% max()
  for(i in seq_along(list)){
    l = length(list[[i]])
    if(l < maxL){
      list[[i]] <- append(list[[i]], values = rep(NA, (maxL - l)))
    }
  }
  list <- as.data.frame(list)
  colnames(list) <- NULL
  list <- t(list)
  colnames(list) <- paste(rep("order", times = maxL), 0:(maxL - 1), sep = "_")
  return(as.data.frame(list))
}

all_path_nodes <- list2df(lapply(distance_to_C1qa_all_path, as_ids))
all_path_nodes <- all_path_nodes %>% filter(!is.na(order_0))


inter_len <- apply(all_path_nodes, 1, intersect, y = c("13136", "12259")) %>% 
  lapply(na.omit) %>% 
  sapply(length)


filter_index <- apply(all_path_nodes, 1, is.na) %>% 
  apply(2, sum) 

retained_path <- all_path_nodes[inter_len == 2, ]

o1 <- all_path_df %>% 
  filter(to %in% (retained_path %>% pull(order_0) %>% unique())|
         from %in% (retained_path %>% pull(order_1) %>% unique()))

o2 <- all_path_df %>% 
  filter(to %in% (retained_path %>% pull(order_1) %>% unique())|
         from %in% (retained_path %>% pull(order_2) %>% unique()))

o3 <- all_path_df %>% 
  filter(from %in% (retained_path %>% pull(order_2) %>% unique())| 
         to %in% (retained_path %>% pull(order_3) %>% unique()))

o4 <- all_path_df %>% 
  filter(from %in% (retained_path %>% pull(order_3) %>% unique())| 
         to %in% (retained_path %>% pull(order_4) %>% unique()))

filtered_path <- rbind(o1, o2, o3, o4)
filtered_path %>% head()
```

```{r}
N <- tibble::tibble(
  ids = c(filtered_path$from, filtered_path$to) %>% unique()
) %>% 
  mutate(shape = ifelse(grepl("^cpd:|^gl:|^dr:", ids, ignore.case = F), "21", "22")) 

E <- filtered_path %>% 
  dplyr::select(from, to, everything())
```


```{r, message=FALSE, warning=FALSE}
g <- tbl_graph(nodes = N, edges = E, directed = T)

# ll <- create_layout(g, "nicely")
set.seed(123)
g %>%  
  mutate(names = names_to_display[ids]) %>% 
  ggraph(layout = "lgl") +
  geom_edge_link(aes(filter = (angle == 30), 
                     edge_linetype = factor(lty)), 
                 end_cap = circle(1.5, "mm"), 
                 start_cap = circle(1, "mm"), 
                 arrow = arrow(length = unit(1, "mm")), 
                 show.legend = F, 
                 edge_width = 0.2) +
  geom_edge_link(aes(filter = (angle == 90), 
                     edge_linetype = factor(lty)), 
                 arrow = arrow(angle = 90, length = unit(1, "mm")), 
                 end_cap = circle(1.5, "mm"), 
                 show.legend = F, 
                 edge_width = 0.2) +
  geom_node_point(aes(shape = shape), 
                  fill ="grey", 
                  size = 2, 
                  show.legend = F, 
                  color = "grey") +
  geom_node_point(aes(shape = shape, filter = (names %in% c("C1qa", "Cd55"))), 
                  fill = "red", 
                  size = 2, 
                  show.legend = F, 
                  color = "red") +
  geom_node_text(aes(label = names), size = 0.5) +
  scale_shape_manual(values = c("21" = 22, "22" = 21)) +
  theme_graph() 

ggsave(filename = "../res/C1q-C3/C1qa-signal-path.pdf")
```

```{r}
as_tbl_graph(all_path_df) %>% 
  mutate(
    dist_to_C1qa = bfs_dist(root = .N()$name == "12259", mode = "all")
  ) %>% 
  filter(!is.na(dist_to_C1qa), .N()$name == "13136")
```




