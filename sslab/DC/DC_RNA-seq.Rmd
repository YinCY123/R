---
title: "DC_RNA-seq"
author: "yincy"
date: "11/30/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```


```{r}
library(readxl)
library(magrittr)
library(tidyverse)
library(edgeR)
library(biomaRt)
library(pheatmap)
library(factoextra)
library(RColorBrewer)
```


```{r}
dc <- read_xlsx(path = "reads-counts.xlsx")
dc <- dc[, -1]
colnames(dc) <- c("Symbol", "ATP_3um", "ATP_3um+inh", "ATP_500um", "control")
```



```{r filtering}
dc[, 2:5] <- apply(dc[, 2:5], 2, FUN = function(x){(x * 1e6) / colSums(dc[, -1])})

index <- c()
for(i in 1:dim(dc)[1]){
  index <- c(index, sum(dc[i, 2:5] >= 1) >= 2)
}
table(index)
```

```{r}
dc <- dc[index, ]
dc
```


id conversion  
```{r}
mmart <- useEnsembl(biomart = "ensembl", 
                    dataset = "mmusculus_gene_ensembl")
```


```{r}
genes <- getBM(attributes = c("ensembl_gene_id", "entrezgene_id", "mgi_symbol"),
               filters = "mgi_symbol",
               values = dc[, 1, drop = T],
               mart = mmart)
```


```{r}
dc <- left_join(dc, genes, by = c("Symbol" = "mgi_symbol"))
dc <- dc %>% 
  dplyr::select(ensembl_gene_id, entrezgene_id, Symbol, starts_with('ATP'), control)
dc
```


```{r}
hc.dc <- hclust(d = get_dist(x = t(dc[, 4:7]), method = "spearman"), method = "ward.D2")
  
fviz_dend(x = hc.dc,
          horiz = T,
          ggtheme = theme_classic(),
          lwd = 1,
          cex = 0.8,
          main = "Cluster Distance",
          ylab = "distance")
```



## DE genes  
```{r}
dc_mutate <- dc %>% 
  mutate(
    atp.3_vs_control_fc = ATP_3um / control,
    atp.500_vs_control_fc = ATP_500um / control,
    atp.3.inh_vs_control_fc = `ATP_3um+inh` / control,
    )
```


### 3uM ATP - Control  
```{r}
atp.3_ctl_deg <- dc_mutate %>% 
  filter(atp.3_vs_control_fc >= 2 | atp.3_vs_control_fc <= 0.5) %>% 
  dplyr::select(Symbol, entrezgene_id,  ATP_3um,control, atp.3_vs_control_fc) %>% 
  arrange(atp.3_vs_control_fc)

atp.3_ctl_deg
```


```{r}
atp.500_ctl_deg <- dc_mutate %>% 
  filter(atp.500_vs_control_fc >= 2 | atp.500_vs_control_fc <= 0.5) %>% 
  dplyr::select(Symbol, entrezgene_id, ATP_500um, control, atp.500_vs_control_fc)

atp.500_ctl_deg
```

##### Intersect of differential expresed genes  
```{r}
VennDiagram::venn.diagram(x = list(ATP.3um_Control_DEG = atp.3_ctl_deg$Symbol, ATP.500_Control_DEG = atp.500_ctl_deg$Symbol),
                          filename = "ATP.3um_DEG_VS_ATP.500um_DEG.tiff",
                          fill = brewer.pal(n = 4, name = "Set1")[1:2],
                          height = 10000,
                          width = 10000,
                          main = "3uM ATP and 500uM ATP vs Control differential expressed genes",
                          main.cex = 3)
```
![](./ATP.3um_DEG_VS_ATP.500um_DEG.tiff)


```{r}
go_atp.3 <- goana(de = atp.3_ctl_deg$entrezgene_id, species = "Mm")
```


```{r}
go_atp.3 %>% 
  filter(Ont == "BP" & P.DE <= 0.05) %>% 
  arrange(P.DE)
```

```{r}
listAttributes(mmart, page = "feature_page")
```


```{r}
go_atp.3 <- getBM(attributes = c("go_id", "name_1006", "definition_1006", "goslim_goa_accession", "goslim_goa_description", "mgi_symbol"), 
                  filters = "mgi_symbol",
                  values = atp.3_ctl_deg$Symbol,
                  mart = mmart)
```




