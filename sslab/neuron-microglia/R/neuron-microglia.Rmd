---
title: "neuron microglia"
author: "yincy"
date: "1/4/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# kv4.3 and Pdgfrb in KEGG pathway  

```{r, message=FALSE}
library(tidygraph)
library(ggraph)
library(igraph)
library(org.Mm.eg.db)
library(tidyverse)
```


```{r}
kegg_pathways <- readRDS(file = "../../P2y12r-and-C1q/data/KEGG/KEGG_pathways_formatted.rds")
names_to_display <- readRDS(file = "../../P2y12r-and-C1q/data/KEGG/names_to_display.rds")
```


```{r}
genes_info <- select(x = org.Mm.eg.db, 
                    keys = c("Kcnd3", "Pdgfrb"), 
                    keytype = "SYMBOL", 
                    columns = c("SYMBOL", "ENTREZID", "ENSEMBL"))

genes_info
```

Kcnd3 predicted transcription factors  
```{r}
entrez <- c("YY1" = "22632", 
            "POU2F2" = "18987", 
            "LyF-1" = "22778", 
            "Sp1" = "20683", 
            "RXR-alpha" = "20181", 
            "POU5F1" = "18999", 
            "POU3F1" = "18991", 
            "Pax-5" = "18507", 
            "POU2F1a" = "18986", 
            "RelA" = "19697", 
            "CP2" = "21422", 
            "NF-kappaB1" = "18033", 
            "NF-AT1" = "18019", 
            "TFE3-S" = "209446", 
            "TCF-1(P)" = "21414", 
            "HNF-3" = "14461", 
            "NF-muNR" = "13047", 
            "COE1" = "13591", 
            "HNF-6" = "15379", 
            "Yi" = "67180", 
            "PU.1" = "20375", 
            "Nkx2-1" = "21869", 
            "AhR" = "11622", 
            "MyoD" = "17927", 
            "E2F-1" = "13555", 
            "HNF-3beta" = "15376", 
            "HES-1" = "15205", 
            "AP-1.1" = "16476", 
            "AP-1.2" = "14281", 
            "USF-1" = "22278", 
            "GATA-1" = "14460", 
            "DEC2" = "79362", 
            "c-Rel" = "19696", 
            "myogenin" = "17928", 
            "MTF-1" = "17764", 
            "STAT1" = "20846", 
            "GATA-2" = "14461", 
            "C/EBPalpha" = "12606", 
            "GR" = "14815", 
            "JunD" = "16478", 
            "c-Jun" = "16476", 
            "NF-1.1" = "18027", 
            "NF-1.2" = "18028", 
            "NF-1.3" = "18029", 
            "NF-1.4" = "18032", 
            "NF-AT4" = "18021", 
            "HOXA5" = "15402", 
            "c-Fos" = "14281", 
            "C/EBPbeta" = "12608")
entrez
tf <- select(EnsDb.Mmusculus.v79, 
             keys = entrez, 
             keytype = "ENTREZID", 
             columns = c("SYMBOL", "ENTREZID"))

tf
```

```{r}
tf_info <- read.table(file = "clipboard", header = T, sep = ";", row.names = NULL)
cn <- colnames(tf_info) %>% .[-1]
colnames(tf_info) <- cn
tf_info <- tf_info[, c(-1, - dim(tf_info)[2])]

tf_info$Factor.name <- str_replace(tf_info$Factor.name, " \\[[:alnum:]+\\]$", "")
tf_info %>% 
    arrange(RE.equally) %>% 
    pull(Factor.name) %>% unique()
```

load KEGG pathways  
```{r}
pathways <- readRDS(file = "../../P2y12r-and-C1q/data/KEGG/KEGG_pathways_formatted.rds")
names_to_display <- readRDS(file = "../../P2y12r-and-C1q/data/KEGG/names_to_display.rds")
```


Pdgfrb downstream genes  
```{r}
ig <- graph_from_data_frame(d = pathways[, 1:2], directed = T)
dist_to_pdgfrb <- distances(graph = ig, 
                            v = V(ig), 
                            to = V(ig)$name == "18596", 
                            mode = "in", 
                            algorithm = "unweighted")

dist_to_pdgfrb_genes <- dist_to_pdgfrb %>% 
    as.data.frame() %>% 
    rownames_to_column("entrez") %>% 
    magrittr::set_colnames(c("entrez", "dist")) %>% 
    dplyr::filter(!is.infinite(dist)) %>% 
    dplyr::filter(grepl("^[0-9]", entrez))

tf_downstream_Pdgfrb <- distances(graph = ig, 
                            v = V(ig)$name %in% entrez, 
                            to = V(ig)$name == "18596", 
                            mode = "in", 
                            algorithm = "unweighted") %>% 
    as.data.frame() %>% 
    rownames_to_column("entrez") %>% 
    magrittr::set_colnames(c("entrez", "dist_to_pdgfrb")) %>% 
    dplyr::filter(!is.infinite(dist_to_pdgfrb)) %>% 
    dplyr::pull(entrez)

tf_downstream_Pdgfrb <- tf[tf$ENTREZID %in% tf_downstream_Pdgfrb, ]
```

```{r}
ego_size(ig, order = 5, nodes = V(ig)$name == "18596")
```

```{r}
paths_to_tf <- shortest_paths(graph = ig, 
               from = V(ig)$name == "18596", 
               to = V(ig)$name %in% tf_downstream_Pdgfrb$ENTREZID)

len <- paths_to_tf$vpath %>% sapply(as_ids) %>% sapply(length)

o1 <- paths_to_tf$vpath %>% sapply(as_ids) %>% sapply("[[", 1) %>% unique()
o2 <- paths_to_tf$vpath %>% sapply(as_ids) %>% sapply("[[", 2) %>% unique()
o3 <- paths_to_tf$vpath %>% sapply(as_ids) %>% sapply("[[", 3) %>% unique()
o4 <- paths_to_tf$vpath %>% sapply(as_ids) %>% .[len > 3] %>% sapply("[[", 4) %>% unique()
o5 <- paths_to_tf$vpath %>% sapply(as_ids) %>% .[len > 4] %>% sapply("[[", 5) %>% unique()
o6 <- paths_to_tf$vpath %>% sapply(as_ids) %>% .[len > 5] %>% sapply("[[", 6) %>% unique()
o7 <- paths_to_tf$vpath %>% sapply(as_ids) %>% .[len > 6] %>% sapply("[[", 7) %>% unique()
```

```{r}
p1 <- pathways %>% 
    dplyr::filter(from %in% o1 & to %in% o2)
p2 <- pathways %>% 
    dplyr::filter(from %in% o2 & to %in% o3)
p3 <- pathways %>% 
    dplyr::filter(from %in% o3 & to %in% o4)
p4 <- pathways %>% 
    dplyr::filter(from %in% o4 & to %in% o5)
p5 <- pathways %>% 
    dplyr::filter(from %in% o5 & to %in% o6)
p6 <- pathways %>% 
    dplyr::filter(from %in% o6 & to %in% o7)


filtered_path <- rbind(p1, p2, p3, p4, p5, p6)
```

```{r}
ig <- graph_from_data_frame(d = filtered_path, directed = T)
```

```{r}
vc <- rep("gray", length(V(ig)))
vc[V(ig)$name %in% tf_downstream_Pdgfrb$ENTREZID] <- "orange"
vc[V(ig)$name == "18596"] <- "blue"

plot(ig, 
     vertex.size = 10, 
     vertex.color = vc, 
     vertex.label = names_to_display[V(ig)$name], 
     vertex.label.cex = 0.6, 
     vertex.label.dist = 0, 
     vertex.label.color = "black",
     vertex.frame.color = NULL, 
     edge.arrow.size = 0.4, 
     edge.label = E(ig)$edge_label, 
     edge.lty = E(ig)$lty)
```




